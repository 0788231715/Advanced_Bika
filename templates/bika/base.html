<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% if site_info %}{{ site_info.name }}{% else %}Bika{% endif %}{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    
    {% block extra_css %}{% endblock %}
</head>
<body class="{% if user.is_authenticated %}user-authenticated user-{{ user.user_type }}{% else %}user-anonymous{% endif %}">
    <!-- Navigation -->
    {% include 'bika/partials/header.html' %}

    <!-- Notification Alerts -->
    {% if user.is_authenticated %}
    <div class="container-fluid bg-light border-bottom">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <div class="notification-alerts">
                            <a href="{% url 'bika:notifications' %}" class="btn btn-sm btn-warning position-relative">
                                <i class="fas fa-bell"></i>
                                Notifications
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationCount">
                                    {{ user.notifications.unread.count|default:0 }}
                                </span>
                            </a>
                        </div>
                        
                        <!-- Quick Actions based on User Role -->
                        <div class="quick-actions">
                            <div class="btn-group btn-group-sm">
                                <!-- Admin Only Actions -->
                                {% if user.is_staff or user.user_type == 'admin' %}
                                <a href="{% url 'bika:admin_dashboard' %}" class="btn btn-outline-primary">
                                    <i class="fas fa-tachometer-alt"></i> Admin Dashboard
                                </a>
                                <a href="{% url 'bika:storage_sites' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-warehouse"></i> Storage Sites
                                </a>
                                <a href="/admin/bika/productdataset/" class="btn btn-outline-info">
                                    <i class="fas fa-database"></i> Manage Datasets
                                </a>
                                {% endif %}
                                
                                <!-- Vendor Actions -->
                                {% if user.user_type == 'vendor' or user.is_staff %}
                                <a href="{% url 'bika:vendor_dashboard' %}" class="btn btn-outline-info">
                                    <i class="fas fa-store"></i> Vendor Dashboard
                                </a>
                                <a href="{% url 'bika:vendor_product_list' %}" class="btn btn-outline-success">
                                    <i class="fas fa-box"></i> My Products
                                </a>
                                <a href="{% url 'bika:track_my_products' %}" class="btn btn-outline-warning">
                                    <i class="fas fa-map-marker-alt"></i> Track Products
                                </a>
                                {% endif %}
                                
                                <!-- Customer Actions -->
                                {% if user.user_type == 'customer' %}
                                <a href="{% url 'bika:cart' %}" class="btn btn-outline-primary position-relative">
                                    <i class="fas fa-shopping-cart"></i> My Cart
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary cart-count-badge" style="display: {% if user.cart.items.count > 0 %}inline{% else %}none{% endif %};">
                                        {{ user.cart.items.count|default:0 }}
                                    </span>
                                </a>
                                <a href="{% url 'bika:wishlist' %}" class="btn btn-outline-success position-relative">
                                    <i class="fas fa-heart"></i> Wishlist
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success wishlist-count-badge" style="display: {% if user.wishlist.items.count > 0 %}inline{% else %}none{% endif %};">
                                        {{ user.wishlist.items.count|default:0 }}
                                    </span>
                                </a>
                                <a href="{% url 'bika:user_orders' %}" class="btn btn-outline-info">
                                    <i class="fas fa-receipt"></i> My Orders
                                </a>
                                {% endif %}
                                
                                <!-- Common Actions for All Authenticated Users -->
                                <a href="{% url 'bika:scan_product' %}" class="btn btn-outline-warning">
                                    <i class="fas fa-qrcode"></i> Scan Product
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Real-time Alert Banner (Admin & Vendor Only) -->
    {% if user.is_staff or user.user_type == 'vendor' or user.user_type == 'admin' %}
    <div id="realTimeAlerts" class="alert alert-warning alert-dismissible fade show mb-0 d-none" role="alert">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-10">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong id="alertTitle">System Alert:</strong>
                    <span id="alertMessage">Monitoring active</span>
                </div>
                <div class="col-md-2 text-end">
                    <a href="{% url 'bika:notifications' %}" class="btn btn-sm btn-outline-dark">View Alerts</a>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Main Content -->
    <main>
        <!-- Messages Display -->
        {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {% if message.tags == 'success' %}
                <i class="fas fa-check-circle me-2"></i>
                {% elif message.tags == 'error' %}
                <i class="fas fa-exclamation-circle me-2"></i>
                {% elif message.tags == 'warning' %}
                <i class="fas fa-exclamation-triangle me-2"></i>
                {% elif message.tags == 'info' %}
                <i class="fas fa-info-circle me-2"></i>
                {% endif %}
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% block content %}
        <!-- Page content will be injected here -->
        {% endblock %}
    </main>

    <!-- Footer -->
    {% include 'bika/partials/footer.html' %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Custom JS -->
    <script src="{% static 'js/script.js' %}"></script>
    
    <!-- Security and Role-Based Implementation -->
    <script>
        // Security configuration - Convert Django template variables to JS
        const SECURITY_CONFIG = {
            authRequired: {% if user.is_authenticated %}false{% else %}true{% endif %},
            userRole: "{{ user.user_type|default:'anonymous' }}",
            isStaff: {% if user.is_staff %}true{% else %}false{% endif %},
            loginUrl: "{% url 'bika:login' %}",
            homeUrl: "{% url 'bika:home' %}",
            username: "{{ user.username|default:'Guest' }}",
            csrfToken: "{{ csrf_token }}"
        };

        // Enhanced security initialization
        document.addEventListener('DOMContentLoaded', function() {
            initializeSecurity();
            initializeRoleBasedFeatures();
            initializeCommonFeatures();
        });

        // Security initialization
        function initializeSecurity() {
            console.log('Initializing Bika Security System...');
            console.log('User:', SECURITY_CONFIG.username, 'Role:', SECURITY_CONFIG.userRole);
            
            // Add security classes to body
            if (SECURITY_CONFIG.authRequired) {
                document.body.classList.add('user-anonymous');
                document.body.classList.remove('user-authenticated');
                clearSensitiveData();
            } else {
                document.body.classList.add('user-authenticated');
                document.body.classList.remove('user-anonymous');
            }

            // Prevent back navigation after logout
            if (performance.navigation && performance.navigation.type === 2) {
                console.log('Page loaded from cache - refreshing for security');
                setTimeout(() => window.location.reload(), 100);
            }

            // Auto-hide messages after 5 seconds
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                if (!alert.classList.contains('alert-permanent')) {
                    setTimeout(() => {
                        if (alert.classList.contains('show')) {
                            const bsAlert = new bootstrap.Alert(alert);
                            bsAlert.close();
                        }
                    }, 5000);
                }
            });
        }

        // Role-based feature initialization
        function initializeRoleBasedFeatures() {
            if (SECURITY_CONFIG.authRequired) return;

            // Initialize features based on user role
            switch(SECURITY_CONFIG.userRole) {
                case 'admin':
                case 'vendor':
                    initializeAdminVendorFeatures();
                    break;
                case 'customer':
                    initializeCustomerFeatures();
                    break;
            }

            // Common authenticated features
            if (document.getElementById('barcodeScanner')) {
                initializeRealBarcodeScanner();
            }

            // Initialize UI components
            initializeUIComponents();
        }

        // Common features initialization
        function initializeCommonFeatures() {
            // Tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
            
            // Popovers
            const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            popoverTriggerList.map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
        }

        // Admin and Vendor specific features
        function initializeAdminVendorFeatures() {
            console.log('Initializing admin/vendor features');
            // Real-time notifications for admin/vendor
            startNotificationPolling();
        }

        // Customer specific features
        function initializeCustomerFeatures() {
            console.log('Initializing customer features');
            // Customer-specific initialization
        }

        // UI components initialization
        function initializeUIComponents() {
            // Additional UI components can be initialized here
        }

        // Security utility functions
        function clearSensitiveData() {
            localStorage.removeItem('user_data');
            localStorage.removeItem('cart_data');
            localStorage.removeItem('sensitive_info');
            sessionStorage.clear();
        }

        function requireAuthentication() {
            if (SECURITY_CONFIG.authRequired) {
                console.log('Authentication required - redirecting to login');
                window.location.href = SECURITY_CONFIG.loginUrl + '?next=' + encodeURIComponent(window.location.pathname);
                return false;
            }
            return true;
        }

        function requireRole(allowedRoles) {
            if (!requireAuthentication()) return false;
            
            if (!allowedRoles.includes(SECURITY_CONFIG.userRole) && !SECURITY_CONFIG.isStaff) {
                showAccessDeniedMessage();
                return false;
            }
            return true;
        }

        function showAccessDeniedMessage() {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-ban me-2"></i>
                <strong>Access Denied:</strong> You don't have permission to access this feature.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const main = document.querySelector('main');
            if (main) {
                main.insertBefore(alertDiv, main.firstChild);
            }
        }

        // Enhanced fetch with security
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            return originalFetch.apply(this, args).then(response => {
                if (response.status === 401) {
                    handleUnauthorized();
                    return Promise.reject(new Error('Authentication required'));
                }
                if (response.status === 403) {
                    showAccessDeniedMessage();
                    return Promise.reject(new Error('Access denied'));
                }
                return response;
            }).catch(error => {
                handleAjaxError(error);
                throw error;
            });
        };

        function handleUnauthorized() {
            console.log('Unauthorized access detected');
            clearSensitiveData();
            window.location.href = SECURITY_CONFIG.loginUrl + '?next=' + encodeURIComponent(window.location.pathname);
        }

        // Real-time notification polling (Admin/Vendor only)
        function startNotificationPolling() {
            if (SECURITY_CONFIG.authRequired) return;

            function checkRealNotifications() {
                fetch("{% url 'bika:unread_notifications_count' %}")
                    .then(response => {
                        if (response.status === 401) {
                            handleUnauthorized();
                            return;
                        }
                        if (!response.ok) throw new Error('Network error');
                        return response.json();
                    })
                    .then(data => {
                        const notificationCount = document.getElementById('notificationCount');
                        if (notificationCount) {
                            notificationCount.textContent = data.unread_count || 0;
                        }
                        
                        // Show critical alerts for admin/vendor
                        if (data.critical_count > 0) {
                            showCriticalAlert(data.critical_count);
                        }
                    })
                    .catch(error => {
                        console.error('Notification error:', error);
                        const notificationCount = document.getElementById('notificationCount');
                        if (notificationCount) notificationCount.textContent = '0';
                    });
            }

            // Check every 30 seconds
            setInterval(checkRealNotifications, 30000);
            checkRealNotifications(); // Initial check
        }

        function showCriticalAlert(criticalCount) {
            const alertBanner = document.getElementById('realTimeAlerts');
            if (alertBanner) {
                document.getElementById('alertTitle').textContent = 'Critical Alert:';
                document.getElementById('alertMessage').textContent = 
                    `${criticalCount} urgent product issue(s) detected`;
                alertBanner.classList.remove('d-none');
                alertBanner.classList.add('show');
                
                setTimeout(() => {
                    if (alertBanner.classList.contains('show')) {
                        alertBanner.classList.remove('show');
                        setTimeout(() => alertBanner.classList.add('d-none'), 150);
                    }
                }, 10000);
            }
        }

        // Enhanced error handling
        function handleAjaxError(error) {
            console.error('AJAX Error:', error);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> ${error.message || 'Something went wrong. Please try again.'}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const main = document.querySelector('main');
            if (main) {
                main.insertBefore(errorDiv, main.firstChild);
            }
            
            setTimeout(() => {
                if (errorDiv.parentNode) errorDiv.remove();
            }, 5000);
        }

        // Secure API utility function
        window.makeApiCall = function(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': SECURITY_CONFIG.csrfToken
                }
            };
            
            return fetch(url, { ...defaultOptions, ...options })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    handleAjaxError(error);
                    throw error;
                });
        };

        // Secure cart management
        window.addToCart = function(productId, quantity = 1) {
            if (!requireAuthentication()) return Promise.reject(new Error('Authentication required'));

            const formData = new FormData();
            formData.append('product_id', productId);
            formData.append('quantity', quantity);
            formData.append('csrfmiddlewaretoken', SECURITY_CONFIG.csrfToken);

            return fetch('{% url "bika:add_to_cart" 0 %}'.replace('0', productId), {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateCartCount(data.cart_count);
                    return data;
                }
                throw new Error(data.message || 'Failed to add to cart');
            });
        };

        // Secure wishlist management
        window.toggleWishlist = function(productId) {
            if (!requireAuthentication()) return Promise.reject(new Error('Authentication required'));

            const wishlistButton = document.querySelector(`[data-product-id="${productId}"]`);
            const isInWishlist = wishlistButton?.classList.contains('active');

            const url = isInWishlist ? 
                '{% url "bika:remove_from_wishlist" 0 %}'.replace('0', productId) :
                '{% url "bika:add_to_wishlist" 0 %}'.replace('0', productId);

            return fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': SECURITY_CONFIG.csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && wishlistButton) {
                    wishlistButton.classList.toggle('active');
                    wishlistButton.classList.toggle('text-danger');
                    const icon = wishlistButton.querySelector('i');
                    if (icon) {
                        icon.classList.toggle('fas');
                        icon.classList.toggle('far');
                    }
                    
                    const wishlistBadge = document.querySelector('.wishlist-count-badge');
                    if (wishlistBadge) {
                        wishlistBadge.textContent = data.wishlist_count;
                    }
                    
                    return data;
                }
                throw new Error(data.message || 'Wishlist operation failed');
            });
        };

        // Cart count update
        function updateCartCount(count) {
            const cartBadge = document.querySelector('.cart-count-badge');
            if (cartBadge) {
                cartBadge.textContent = count;
                cartBadge.style.display = count > 0 ? 'inline' : 'none';
            }
        }

        // Search functionality
        window.performSearch = function(query) {
            if (query.trim().length < 2) return;
            
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.submit();
            } else {
                window.location.href = `{% url 'bika:product_search' %}?q=${encodeURIComponent(query)}`;
            }
        };

        // Barcode scanning functions
        window.initializeRealBarcodeScanner = function() {
            const video = document.getElementById('barcodeScanner');
            if (video && navigator.mediaDevices) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                    initializeBarcodeDetection(video);
                })
                .catch(function(error) {
                    console.error("Camera access error:", error);
                    alert("Unable to access camera. Please check permissions.");
                });
            }
        };

        function initializeBarcodeDetection(video) {
            if (!('BarcodeDetector' in window)) {
                console.warn('Barcode Detection API not supported');
                return;
            }

            const barcodeDetector = new BarcodeDetector({
                formats: ['qr_code', 'ean_13', 'ean_8', 'code_128', 'upc_a']
            });

            function detectBarcode() {
                barcodeDetector.detect(video)
                    .then(barcodes => {
                        if (barcodes.length > 0) {
                            const barcode = barcodes[0];
                            handleDetectedBarcode(barcode.rawValue);
                        }
                        requestAnimationFrame(detectBarcode);
                    })
                    .catch(err => {
                        console.error('Barcode detection error:', err);
                        requestAnimationFrame(detectBarcode);
                    });
            }
            detectBarcode();
        }

        function handleDetectedBarcode(barcodeValue) {
            console.log('Barcode detected:', barcodeValue);
            
            const loadingIndicator = document.getElementById('scanLoading');
            if (loadingIndicator) loadingIndicator.classList.remove('d-none');

            fetch(`/api/product/${barcodeValue}/`)
                .then(response => {
                    if (!response.ok) throw new Error('Product not found');
                    return response.json();
                })
                .then(productData => {
                    if (productData.slug) {
                        window.location.href = `/products/${productData.slug}/`;
                    } else {
                        alert('Product found but no details available.');
                    }
                })
                .catch(error => {
                    console.error('Product lookup error:', error);
                    alert('Product not found. Please try another barcode.');
                })
                .finally(() => {
                    if (loadingIndicator) loadingIndicator.classList.add('d-none');
                });
        }

        // Product tracking
        window.trackRealProduct = function(productBarcode) {
            return fetch(`/api/product/${productBarcode}/`)
                .then(response => {
                    if (!response.ok) throw new Error('Product not found');
                    return response.json();
                });
        };
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>