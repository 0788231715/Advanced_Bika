{% extends 'bika/base.html' %}
{% load static %}

{% block title %}Add Product - Bika{% endblock %}

{% block extra_css %}
<style>
.product-form-section {
    background: #f8f9fa;
    min-height: 100vh;
    padding: 30px 0;
}

.form-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
    border: none;
    margin-bottom: 30px;
}

.form-card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0 !important;
    padding: 25px 30px;
}

.form-card-body {
    padding: 30px;
}

.form-section {
    margin-bottom: 30px;
    padding-bottom: 25px;
    border-bottom: 1px solid #e9ecef;
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.section-title {
    color: #2c3e50;
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-title i {
    color: #667eea;
}

.form-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    padding: 12px 15px;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 10px;
    padding: 12px 30px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.help-text {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 5px;
}

.required-field::after {
    content: " *";
    color: #dc3545;
}

.image-preview {
    max-width: 200px;
    max-height: 200px;
    border-radius: 8px;
    border: 2px dashed #dee2e6;
    padding: 10px;
}

.price-input-group .input-group-text {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-right: none;
}

.price-input-group .form-control {
    border-left: none;
}

.featured-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.inventory-alert {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

@media (max-width: 768px) {
    .form-card-body {
        padding: 20px;
    }
    
    .section-title {
        font-size: 1.1rem;
    }
}

.field-errors {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 5px;
}

.is-invalid {
    border-color: #dc3545 !important;
}

.is-valid {
    border-color: #28a745 !important;
}
</style>
{% endblock %}

{% block content %}
<section class="product-form-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Header Card -->
                <div class="form-card">
                    <div class="form-card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="mb-2"><i class="fas fa-plus-circle me-2"></i>{{ title }}</h2>
                                <p class="mb-0">Fill in the details below to list your product on Bika Marketplace</p>
                            </div>
                            <div class="featured-badge">
                                <i class="fas fa-store me-1"></i>Vendor Panel
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Form -->
                <div class="form-card">
                    <div class="form-card-body">
                        <form method="post" enctype="multipart/form-data" novalidate id="product-form">
                            {% csrf_token %}
                            
                            {% if form.errors %}
                            <div class="alert alert-danger">
                                <h6 class="alert-heading">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Please correct the errors below:
                                </h6>
                                <ul class="mb-0 mt-2">
                                    {% for field in form %}
                                        {% for error in field.errors %}
                                            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}

                            <!-- Basic Information Section -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-info-circle"></i>Basic Information
                                </h4>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.name.id_for_label }}" class="form-label required-field">Product Name</label>
                                            {{ form.name }}
                                            {% if form.name.errors %}
                                            <div class="field-errors">
                                                {% for error in form.name.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            <div class="help-text">Enter a clear and descriptive product name</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.sku.id_for_label }}" class="form-label required-field">SKU</label>
                                            {{ form.sku }}
                                            {% if form.sku.errors %}
                                            <div class="field-errors">
                                                {% for error in form.sku.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            <div class="help-text">Unique stock keeping unit</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.slug.id_for_label }}" class="form-label required-field">URL Slug</label>
                                            {{ form.slug }}
                                            {% if form.slug.errors %}
                                            <div class="field-errors">
                                                {% for error in form.slug.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            <div class="help-text">URL-friendly version of the name (e.g., "my-awesome-product")</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.category.id_for_label }}" class="form-label required-field">Category</label>
                                            {{ form.category }}
                                            {% if form.category.errors %}
                                            <div class="field-errors">
                                                {% for error in form.category.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="{{ form.short_description.id_for_label }}" class="form-label">Short Description</label>
                                    {{ form.short_description }}
                                    {% if form.short_description.errors %}
                                    <div class="field-errors">
                                        {% for error in form.short_description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="help-text">Brief description shown in product listings (max 300 characters)</div>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="{{ form.description.id_for_label }}" class="form-label required-field">Full Description</label>
                                    {{ form.description }}
                                    {% if form.description.errors %}
                                    <div class="field-errors">
                                        {% for error in form.description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="help-text">Detailed product description with features and benefits</div>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="{{ form.tags.id_for_label }}" class="form-label">Tags</label>
                                    {{ form.tags }}
                                    {% if form.tags.errors %}
                                    <div class="field-errors">
                                        {% for error in form.tags.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="help-text">Comma-separated keywords for better searchability</div>
                                </div>
                            </div>

                            <!-- Pricing Section -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-tag"></i>Pricing & Inventory
                                </h4>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.price.id_for_label }}" class="form-label required-field">Price ($)</label>
                                            <div class="input-group price-input-group">
                                                <span class="input-group-text">$</span>
                                                {{ form.price }}
                                            </div>
                                            {% if form.price.errors %}
                                            <div class="field-errors">
                                                {% for error in form.price.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.compare_price.id_for_label }}" class="form-label">Compare Price ($)</label>
                                            <div class="input-group price-input-group">
                                                <span class="input-group-text">$</span>
                                                {{ form.compare_price }}
                                            </div>
                                            {% if form.compare_price.errors %}
                                            <div class="field-errors">
                                                {% for error in form.compare_price.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            <div class="help-text">Original price for showing discounts</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.cost_price.id_for_label }}" class="form-label">Cost Price ($)</label>
                                            <div class="input-group price-input-group">
                                                <span class="input-group-text">$</span>
                                                {{ form.cost_price }}
                                            </div>
                                            {% if form.cost_price.errors %}
                                            <div class="field-errors">
                                                {% for error in form.cost_price.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            <div class="help-text">Your cost for this product</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.tax_rate.id_for_label }}" class="form-label">Tax Rate (%)</label>
                                            {{ form.tax_rate }}
                                            {% if form.tax_rate.errors %}
                                            <div class="field-errors">
                                                {% for error in form.tax_rate.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.stock_quantity.id_for_label }}" class="form-label">Stock Quantity</label>
                                            {{ form.stock_quantity }}
                                            {% if form.stock_quantity.errors %}
                                            <div class="field-errors">
                                                {% for error in form.stock_quantity.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.low_stock_threshold.id_for_label }}" class="form-label">Low Stock Alert</label>
                                            {{ form.low_stock_threshold }}
                                            {% if form.low_stock_threshold.errors %}
                                            <div class="field-errors">
                                                {% for error in form.low_stock_threshold.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            <div class="help-text">Get notified when stock reaches this level</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            {{ form.track_inventory }}
                                            <label class="form-check-label" for="{{ form.track_inventory.id_for_label }}">Track Inventory</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            {{ form.allow_backorders }}
                                            <label class="form-check-label" for="{{ form.allow_backorders.id_for_label }}">Allow Backorders</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Product Details Section -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-cube"></i>Product Details
                                </h4>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.brand.id_for_label }}" class="form-label">Brand</label>
                                            {{ form.brand }}
                                            {% if form.brand.errors %}
                                            <div class="field-errors">
                                                {% for error in form.brand.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.model.id_for_label }}" class="form-label">Model</label>
                                            {{ form.model }}
                                            {% if form.model.errors %}
                                            <div class="field-errors">
                                                {% for error in form.model.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.weight.id_for_label }}" class="form-label">Weight (kg)</label>
                                            {{ form.weight }}
                                            {% if form.weight.errors %}
                                            <div class="field-errors">
                                                {% for error in form.weight.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.dimensions.id_for_label }}" class="form-label">Dimensions (cm)</label>
                                            {{ form.dimensions }}
                                            {% if form.dimensions.errors %}
                                            <div class="field-errors">
                                                {% for error in form.dimensions.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            <div class="help-text">Format: LxWxH</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.material.id_for_label }}" class="form-label">Material</label>
                                            {{ form.material }}
                                            {% if form.material.errors %}
                                            <div class="field-errors">
                                                {% for error in form.material.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.color.id_for_label }}" class="form-label">Color</label>
                                            {{ form.color }}
                                            {% if form.color.errors %}
                                            <div class="field-errors">
                                                {% for error in form.color.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.size.id_for_label }}" class="form-label">Size</label>
                                            {{ form.size }}
                                            {% if form.size.errors %}
                                            <div class="field-errors">
                                                {% for error in form.size.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Status & Settings Section -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-cog"></i>Status & Settings
                                </h4>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.status.id_for_label }}" class="form-label required-field">Status</label>
                                            {{ form.status }}
                                            {% if form.status.errors %}
                                            <div class="field-errors">
                                                {% for error in form.status.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="{{ form.condition.id_for_label }}" class="form-label required-field">Condition</label>
                                            {{ form.condition }}
                                            {% if form.condition.errors %}
                                            <div class="field-errors">
                                                {% for error in form.condition.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            {{ form.is_featured }}
                                            <label class="form-check-label" for="{{ form.is_featured.id_for_label }}">Feature this product</label>
                                            <div class="help-text">Show this product in featured sections</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            {{ form.is_digital }}
                                            <label class="form-check-label" for="{{ form.is_digital.id_for_label }}">Digital Product</label>
                                            <div class="help-text">No physical shipping required</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Images Section -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-images"></i>Product Images
                                </h4>
                                
                                <div class="form-group mb-3">
                                    <label class="form-label">Upload Product Images</label>
                                    <input type="file" class="form-control" name="images" multiple accept="image/*" id="image-upload">
                                    <div class="help-text">
                                        You can select multiple images. The first image will be set as primary.
                                        Supported formats: JPG, PNG, GIF. Max file size: 5MB per image.
                                    </div>
                                </div>

                                <div id="image-preview-container" class="row mt-3" style="display: none;">
                                    <div class="col-12">
                                        <h6 class="mb-3">Selected Images:</h6>
                                        <div id="image-previews" class="d-flex flex-wrap gap-3"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- SEO Section -->
                            <div class="form-section">
                                <h4 class="section-title">
                                    <i class="fas fa-search"></i>SEO Settings
                                </h4>
                                
                                <div class="form-group mb-3">
                                    <label for="{{ form.meta_title.id_for_label }}" class="form-label">Meta Title</label>
                                    {{ form.meta_title }}
                                    {% if form.meta_title.errors %}
                                    <div class="field-errors">
                                        {% for error in form.meta_title.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="help-text">Title for search engines (leave blank to use product name)</div>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="{{ form.meta_description.id_for_label }}" class="form-label">Meta Description</label>
                                    {{ form.meta_description }}
                                    {% if form.meta_description.errors %}
                                    <div class="field-errors">
                                        {% for error in form.meta_description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="help-text">Description for search engines (leave blank to use short description)</div>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="form-section">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <a href="{% url 'bika:vendor_dashboard' %}" class="btn btn-outline-secondary">
                                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                                        </a>
                                    </div>
                                    <div class="d-flex gap-3">
                                        <button type="submit" name="save_draft" value="true" class="btn btn-outline-primary">
                                            <i class="fas fa-save me-2"></i>Save as Draft
                                        </button>
                                        <button type="submit" name="publish" value="true" class="btn btn-primary">
                                            <i class="fas fa-rocket me-2"></i>Publish Product
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Help Card -->
                <div class="form-card">
                    <div class="form-card-body">
                        <h5 class="section-title">
                            <i class="fas fa-lightbulb"></i>Tips for Success
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Use high-quality images</li>
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Write detailed descriptions</li>
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Set competitive pricing</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Use relevant keywords</li>
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Keep inventory updated</li>
                                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Respond to customer reviews</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-generate slug from product name
    const nameField = document.getElementById('{{ form.name.id_for_label }}');
    const slugField = document.getElementById('{{ form.slug.id_for_label }}');
    
    if (nameField && slugField) {
        nameField.addEventListener('blur', function() {
            if (!slugField.value) {
                const slug = this.value
                    .toLowerCase()
                    .trim()
                    .replace(/[^a-z0-9 -]/g, '') // Remove invalid chars
                    .replace(/\s+/g, '-') // Replace spaces with -
                    .replace(/-+/g, '-'); // Replace multiple - with single -
                slugField.value = slug;
            }
        });
    }

    // Auto-calculate discount percentage
    const priceField = document.getElementById('{{ form.price.id_for_label }}');
    const comparePriceField = document.getElementById('{{ form.compare_price.id_for_label }}');
    
    function calculateDiscount() {
        if (priceField && comparePriceField && priceField.value && comparePriceField.value) {
            const price = parseFloat(priceField.value);
            const comparePrice = parseFloat(comparePriceField.value);
            
            if (comparePrice > price) {
                const discount = ((comparePrice - price) / comparePrice) * 100;
                // You can display this somewhere if needed
                console.log('Discount:', discount.toFixed(1) + '%');
            }
        }
    }
    
    if (priceField) priceField.addEventListener('input', calculateDiscount);
    if (comparePriceField) comparePriceField.addEventListener('input', calculateDiscount);

    // Image upload preview
    const imageUpload = document.getElementById('image-upload');
    const previewContainer = document.getElementById('image-preview-container');
    const imagePreviews = document.getElementById('image-previews');
    
    if (imageUpload) {
        imageUpload.addEventListener('change', function(e) {
            const files = e.target.files;
            imagePreviews.innerHTML = '';
            
            if (files.length > 0) {
                previewContainer.style.display = 'block';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'image-preview-item';
                        previewDiv.innerHTML = `
                            <div class="image-preview position-relative" style="width: 120px; height: 120px;">
                                <img src="${e.target.result}" alt="Preview" class="img-fluid rounded" style="width: 100%; height: 100%; object-fit: cover;">
                                <div class="position-absolute top-0 end-0 bg-dark text-white rounded-circle px-2 py-1" style="font-size: 0.7rem;">
                                    ${i + 1}
                                </div>
                            </div>
                        `;
                        imagePreviews.appendChild(previewDiv);
                    };
                    
                    reader.readAsDataURL(file);
                }
            } else {
                previewContainer.style.display = 'none';
            }
        });
    }

    // Form validation enhancement
    const form = document.getElementById('product-form');
    const requiredFields = form.querySelectorAll('.required-field');
    
    // Add required indicator to labels
    requiredFields.forEach(field => {
        const inputId = field.getAttribute('for');
        const input = document.getElementById(inputId);
        if (input) {
            input.required = true;
        }
    });

    form.addEventListener('submit', function(e) {
        let valid = true;
        
        requiredFields.forEach(field => {
            const inputId = field.getAttribute('for');
            const input = document.getElementById(inputId);
            if (input && !input.value.trim()) {
                valid = false;
                input.classList.add('is-invalid');
                
                // Create error message if not exists
                if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('field-errors')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'field-errors';
                    errorDiv.textContent = 'This field is required.';
                    input.parentNode.insertBefore(errorDiv, input.nextSibling);
                }
            } else {
                input.classList.remove('is-invalid');
                // Remove error message if exists
                if (input.nextElementSibling && input.nextElementSibling.classList.contains('field-errors')) {
                    input.nextElementSibling.remove();
                }
            }
        });
        
        if (!valid) {
            e.preventDefault();
            // Scroll to first error
            const firstError = form.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        } else {
            // Show loading state
            const submitButtons = form.querySelectorAll('button[type="submit"]');
            submitButtons.forEach(btn => {
                if (btn === e.submitter) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                    btn.disabled = true;
                    
                    // Re-enable after 10 seconds in case of error
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 10000);
                }
            });
        }
    });

    // Real-time character counter for short description
    const shortDescField = document.getElementById('{{ form.short_description.id_for_label }}');
    if (shortDescField) {
        const counter = document.createElement('div');
        counter.className = 'help-text text-end';
        shortDescField.parentNode.appendChild(counter);
        
        shortDescField.addEventListener('input', function() {
            const count = this.value.length;
            counter.textContent = `${count}/300 characters`;
            
            if (count > 300) {
                counter.classList.add('text-danger');
                this.classList.add('is-invalid');
            } else {
                counter.classList.remove('text-danger');
                this.classList.remove('is-invalid');
            }
        });
        
        // Trigger initially
        shortDescField.dispatchEvent(new Event('input'));
    }

    // Auto-fill meta fields if empty
    const metaTitleField = document.getElementById('{{ form.meta_title.id_for_label }}');
    const metaDescField = document.getElementById('{{ form.meta_description.id_for_label }}');
    
    if (nameField && metaTitleField) {
        nameField.addEventListener('blur', function() {
            if (!metaTitleField.value) {
                metaTitleField.value = this.value;
            }
        });
    }
    
    if (shortDescField && metaDescField) {
        shortDescField.addEventListener('blur', function() {
            if (!metaDescField.value && this.value.length <= 160) {
                metaDescField.value = this.value;
            }
        });
    }
});
</script>
{% endblock %}